// Prisma schema for Supabase (PostgreSQL)
// Ensure you set DATABASE_URL in .env to your Supabase connection string

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GovernanceAction {
  id                Int     @id @default(autoincrement())
  proposalId        String  @unique
  txHash            String
  title             String
  type              String
  status            String
  submissionEpoch   Int
  expiryEpoch       Int
  description       String?
  rationale         String?
  motivation        String?
  anchorUrl         String?
  anchorHash        String?
  constitutionality String?
  references        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  drepVotes  DrepVote[]
  spoVotes   SpoVote[]
  ccVotes    CcVote[]
  statistics VoteStatistics?

  @@index([status])
  @@index([type])
  @@index([proposalId])
  @@index([txHash])
  @@index([type, status])
}

model Drep {
  id             Int      @id @default(autoincrement())
  drepId         String   @unique
  hex            String?
  hasScript      Boolean?
  registered     Boolean?
  deposit        Decimal? // raw deposit amount in lovelace, if provided
  active         Boolean?
  expiresEpochNo Int?
  amount         Decimal? // total delegated amount in lovelace, as reported by Koios
  metaUrl        String?
  metaHash       String?
  metaJson       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  drepVotes DrepVote[]

  @@index([drepId])
  @@index([active])
  @@index([registered])
}

model Spo {
  id            Int      @id @default(autoincrement())
  poolId        String   @unique
  poolIdHex     String?
  status        String?
  ticker        String?
  poolGroup     String?
  metaUrl       String?
  metaHash      String?
  activeEpochNo Int?
  margin        Decimal?
  fixedCost     Decimal?
  pledge        Decimal?
  deposit       Decimal?
  rewardAddr    String?
  owners        Json?
  relays        Json?
  activeStake   Decimal?
  retiringEpoch Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  spoVotes SpoVote[]

  @@index([poolId])
  @@index([ticker])
  @@index([status])
}

model DrepVote {
  id                 Int      @id @default(autoincrement())
  governanceActionId Int
  drepId             String
  drepName           String?
  vote               String
  voteTxHash         String?  @map("vote_tx_hash")
  epochNo            Int?     @map("epoch_no")
  votingPowerAda     Decimal?
  anchorUrl          String?
  anchorHash         String?
  metaJson           Json?    @map("meta_json")
  votedAt            DateTime

  governanceAction GovernanceAction @relation(fields: [governanceActionId], references: [id], onDelete: Cascade)
  drep             Drep?            @relation(fields: [drepId], references: [drepId], onDelete: Cascade)

  @@unique([governanceActionId, drepId])
  @@index([governanceActionId])
  @@index([drepId])
  @@index([vote])
}

model SpoVote {
  id                 Int      @id @default(autoincrement())
  governanceActionId Int
  poolId             String
  poolName           String?
  vote               String
  voteTxHash         String?  @map("vote_tx_hash")
  epochNo            Int?     @map("epoch_no")
  votingPowerAda     Decimal?
  anchorUrl          String?
  anchorHash         String?
  metaJson           Json?    @map("meta_json")
  votedAt            DateTime

  governanceAction GovernanceAction @relation(fields: [governanceActionId], references: [id], onDelete: Cascade)
  spo              Spo?             @relation(fields: [poolId], references: [poolId], onDelete: Cascade)

  @@unique([governanceActionId, poolId])
  @@index([governanceActionId])
  @@index([poolId])
}

model CcVote {
  id                 Int      @id @default(autoincrement())
  governanceActionId Int
  memberId           String
  memberName         String?
  vote               String
  voteTxHash         String?  @map("vote_tx_hash")
  epochNo            Int?     @map("epoch_no")
  anchorUrl          String?
  anchorHash         String?
  metaJson           Json?    @map("meta_json")
  votedAt            DateTime

  governanceAction GovernanceAction @relation(fields: [governanceActionId], references: [id], onDelete: Cascade)

  @@unique([governanceActionId, memberId])
  @@index([governanceActionId])
  @@index([memberId])
  @@index([vote])
}

model VoteStatistics {
  governanceActionId Int @id

  drepYesPercent Decimal?
  drepNoPercent  Decimal?
  drepYesAda     Decimal?
  drepNoAda      Decimal?

  spoYesPercent Decimal?
  spoNoPercent  Decimal?
  spoYesAda     Decimal?
  spoNoAda      Decimal?

  ccYesPercent Decimal?
  ccNoPercent  Decimal?
  ccYesCount   Int?
  ccNoCount    Int?

  totalYes     Int @default(0)
  totalNo      Int @default(0)
  totalAbstain Int @default(0)

  lastUpdated DateTime @default(now())

  action GovernanceAction @relation(fields: [governanceActionId], references: [id], onDelete: Cascade)
}
